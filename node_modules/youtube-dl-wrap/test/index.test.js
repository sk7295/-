const assert = require("assert");
const fs = require("fs");
const os = require("os");

const YoutubeDlWrap = require("..");
const youtubeDlWrap = new YoutubeDlWrap();

const testVideoPath = "test/testVideo.mp4";
const testVideoId = "C0DPdy98e4c";
const testVideoURL = "https://www.youtube.com/watch?v=" + testVideoId;

const isValidVersion = (version) => !isNaN( Date.parse( version.substring(0, 10).replace(/\./g, "-") ) )

const checkFileDownload = function()
{
    let fileName = os.platform() == "win32" ? "youtube-dl.exe" : "youtube-dl";
    assert(fs.existsSync("./" + fileName));
    const stats = fs.statSync("./" + fileName);
    fs.unlinkSync("./" + fileName);
    assert(stats.size > 0);
}

const checkEventEmitter = function(youtubeDlEventEmitter)
{
    return new Promise((resolve, reject) =>
    {
        let progressDefined = false;
        youtubeDlEventEmitter.on("progress", (progressObject) => 
        {
            if(progressObject.percent != undefined      || progressObject.totalSize != undefined ||
               progressObject.currentSpeed != undefined || progressObject.eta != undefined )
               progressDefined = true;
        });

        let youtubeDlEventFound = false;
        youtubeDlEventEmitter.on("youtubeDlEvent", (eventType, eventData) => 
        {
            if(eventType == "youtube" && eventData.includes(testVideoId))
                youtubeDlEventFound = true;
        });

        youtubeDlEventEmitter.on("error", (error) => reject(error));
        youtubeDlEventEmitter.on("close", () => 
        {
            assert(fs.existsSync(testVideoPath));
            const stats = fs.statSync(testVideoPath);
            fs.unlinkSync(testVideoPath);
            assert.strictEqual(stats.size, 514316);
            assert(progressDefined);
            assert(youtubeDlEventFound);
            resolve();
        });
    });
}

describe("downloading youtube-dl binary", function()
{
    it("should download from github", async function()
    {
        await YoutubeDlWrap.downloadFromGithub();
        checkFileDownload();
    });

    it("should download from youtube-dl website", async function()
    {
        await YoutubeDlWrap.downloadFromWebsite();
        checkFileDownload();
    });
});

describe("download video functions", function()
{
    it("should download a video via EventEmitter", async function()
    {
        let youtubeDlEventEmitter = youtubeDlWrap.exec([testVideoURL, "-f", "worst", "-o", "test/testVideo.mp4"]);
        await checkEventEmitter(youtubeDlEventEmitter);
    });

    it("should download a video via Readable Stream", async function()
    {
        let readableStream = youtubeDlWrap.execStream(